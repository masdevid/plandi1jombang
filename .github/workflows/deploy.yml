name: Deploy to Production Server

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - '*.md'
  workflow_dispatch: # Allow manual trigger
    inputs:
      rebuild:
        description: 'Force rebuild Docker images'
        required: false
        type: boolean
        default: false

jobs:
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.changes.outputs.api }}
      frontend: ${{ steps.changes.outputs.frontend }}
      docker: ${{ steps.changes.outputs.docker }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        id: changes
        run: |
          # Check if API files changed
          if git diff --name-only HEAD^ HEAD | grep -E '^(api/|api-server/)'; then
            echo "api=true" >> $GITHUB_OUTPUT
          else
            echo "api=false" >> $GITHUB_OUTPUT
          fi

          # Check if frontend files changed
          if git diff --name-only HEAD^ HEAD | grep -E '^(src/|angular.json|package.json)'; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

          # Check if Docker files changed
          if git diff --name-only HEAD^ HEAD | grep -E '^(Dockerfile|docker-compose.yml|\.env)'; then
            echo "docker=true" >> $GITHUB_OUTPUT
          else
            echo "docker=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          REBUILD_API: ${{ needs.detect-changes.outputs.api == 'true' || needs.detect-changes.outputs.docker == 'true' || github.event.inputs.rebuild == 'true' }}
          REBUILD_FRONTEND: ${{ needs.detect-changes.outputs.frontend == 'true' || github.event.inputs.rebuild == 'true' }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          envs: REBUILD_API,REBUILD_FRONTEND
          script: |
            set -e
            echo "ğŸš€ Starting smart deployment..."

            # Navigate to project directory
            cd ${{ secrets.PROJECT_PATH || '/opt/sd-plandi' }}

            # Save current commit for comparison
            OLD_COMMIT=$(git rev-parse HEAD)

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code from main branch..."
            git fetch origin
            git reset --hard origin/main

            NEW_COMMIT=$(git rev-parse HEAD)

            # Show what changed
            if [ "$OLD_COMMIT" != "$NEW_COMMIT" ]; then
              echo "ğŸ“Š Changes deployed:"
              git log --oneline --decorate $OLD_COMMIT..$NEW_COMMIT | head -5
            else
              echo "âœ“ Already up to date"
              exit 0
            fi

            # Check if .env.docker exists
            if [ ! -f .env.docker ]; then
              echo "âš ï¸  .env.docker not found, please create it manually"
              exit 1
            fi

            # Determine what needs rebuilding
            if [ "$REBUILD_API" = "true" ]; then
              echo "ğŸ”¨ API changes detected - rebuilding API container..."
              docker-compose stop api
              docker-compose build api
              docker-compose up -d api
            else
              echo "âœ“ No API changes - skipping API rebuild"
              # Just restart to pick up code changes (volumes are mounted)
              docker-compose restart api
            fi

            if [ "$REBUILD_FRONTEND" = "true" ]; then
              echo "ğŸ“¦ Frontend changes detected"
              echo "Note: Frontend is static, served by Vercel or nginx"
            fi

            # Ensure all services are running
            echo "ğŸš€ Ensuring all services are running..."
            docker-compose up -d

            # Wait for health check
            echo "â³ Waiting for services to be healthy..."
            sleep 10

            # Check service status
            echo "ğŸ“‹ Service status:"
            docker-compose ps

            # Check API health
            API_PORT=$(grep API_PORT .env.docker | cut -d '=' -f2 || echo "3001")
            if curl -f http://localhost:${API_PORT}/health > /dev/null 2>&1; then
              echo "âœ… API is healthy"
            else
              echo "âš ï¸  API health check failed"
              docker-compose logs --tail=30 api
            fi

            # Show recent logs
            echo "ğŸ“‹ Recent logs:"
            docker-compose logs --tail=20

            # Cleanup old images only if we rebuilt
            if [ "$REBUILD_API" = "true" ]; then
              echo "ğŸ§¹ Cleaning up old images..."
              docker image prune -f
            fi

            echo "âœ… Deployment completed successfully!"
